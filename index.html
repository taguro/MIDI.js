<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
 
    <!-- shims -->
    <script src="./inc/shim/Base64.js" type="text/javascript"></script>
    <script src="./inc/shim/Base64binary.js" type="text/javascript"></script>
    <script src="./inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <!-- midi.js -->
    <script src="./js/midi/audioDetect.js" type="text/javascript"></script>
    <script src="./js/midi/gm.js" type="text/javascript"></script>
    <script src="./js/midi/loader.js" type="text/javascript"></script>
    <script src="./js/midi/plugin.audiotag.js" type="text/javascript"></script>
    <script src="./js/midi/plugin.webaudio.js" type="text/javascript"></script>
    <script src="./js/midi/plugin.webmidi.js" type="text/javascript"></script>
    <!-- utils -->
    <script src="./js/util/dom_request_xhr.js" type="text/javascript"></script>
    <script src="./js/util/dom_request_script.js" type="text/javascript"></script>
    <!-- nextChords -->
    <script src="./probabilities.js"></script>
</head>
<body>
<script>
 
var base = 60;
var tempo = 60/120;
var arpeggio = "";
 
var key =  ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
 
var chordname={"maj":"100010010000",
"min":"100100010000",
"dim":"100100100000",
"aug":"100010001000",
"maj7":"100010010001",
"min7":"100100010010",
"7":"100010010010",
"dim7":"100100100100",
"hdim7":"100100100010",
"minmaj7":"100100010001",
"6":"100010010100",
"maj6":"100010010100",
"min6":"100100010100",
"9":"100010010010001",
"maj9":"100010010001001",
"min9":"100100010010001",
"sus2":"101000010000",
"sus4":"100001010000",
"7(#9)":"100110010010",
"7sus4":"100001010010",
"aug7":"100010001010"};
 
var interval={"m2":1,
"2":2,
"m3":3,
"3":4,
"4":5,
"b5":6,
"5":7,
"#5":8,
"6":9,
"m7":10,
"7":11,
"8":12,
"b9":13,
"9":14,
"11":17,
"#11":18,
"b13":20,
"13":21
}
 
function getNote(_chordname){
    j=0;
    note=[];
    cname=_chordname.split(/[(,),/]/)[0];
    
    tensions=_chordname.split(/[(,)]/).slice(1);
    if(tensions.length!=0){
    	tensions=tensions.slice(0,tensions.length-1);
    }

    inversion=_chordname.split("/").slice(1);
    
    
    for(i=0;i<12;i++){
    	console.log(cname)
        j = chordname[cname].indexOf("1",j);
        if(j == -1){break;}
        note[note.length]=j;
        j=j+1;
    }

    for(var tkey in tensions){
    	tension=tensions[tkey];
    	note[note.length]=interval[tension];
    }

    if(inversion.length!=0){
        newRoot=interval[inversion];
        for(i=0;i<note.length;i++){
            if(note[i]<newRoot){
                note[i]+=12;
            }
	        }
    }

    return note;
};
 
function getMIDI(chord){
    c=chord.split(":");
    _key=c[0];
    _chordname="maj";
    if(c.length==2){
        _chordname=c[1];
    }
 
    root = base + key.indexOf(_key);
    note= getNote(_chordname);
    midi=[];
    for(i=0;i<note.length;i++){
        midi[i]=root+note[i];
    }
    return midi;
};
 
function playMIDI(midi){
    MIDI.loadPlugin({
        soundfontUrl: "./examples/soundfont/",
        instrument: "acoustic_grand_piano",
        onprogress: function(state, progress) {
            console.log(state, progress);
        },
        onsuccess: function() {
            var delay = 0; // play one note every quarter second
            var velocity = 127; // how hard the note hits
            // play the note
            MIDI.setVolume(0, 127);
            for(i=0;i<midi.length;i++){
              if (arpeggio==""){
                for(j=0;j<midi[i].length;j++){
                  MIDI.noteOn(0, midi[i][j], velocity, delay);
                  MIDI.noteOff(0, midi[i][j], delay + tempo);                
                }
              }else{
                var arp=arpeggio.split(" ");
                arp = arp.filter((a)=>{return a!=""});

                t=tempo/arp.length;
                for(j=0; j<arp.length; j++){
                  a=arp[j];
                  for(var noteStr of a){
                    noteIndex=parseInt(noteStr)-1;
                    if(typeof midi[i][noteIndex] === "undefined"){continue;}//ない音は鳴らさない
                    MIDI.noteOn(0, midi[i][noteIndex], velocity, delay+t*j);
                    MIDI.noteOff(0, midi[i][noteIndex], delay + t*(j+1) );
                  }
                }
              }

              delay = delay +tempo;
            }
        }
    });
    return "";
};
 
function playChords(chords){
    _chords=chords.split(/\r\n|\r|\n| |,/);//改行コードもしくは空白もしくはカンマ
    console.log(_chords);
    //_chords = chords.split(" ");
    _midi = []
    for(_c in _chords){
        if(_chords[_c].length==0){continue;}
	if(_chords[_c]=="N"){_midi[_midi.length]=[];continue;}
        _midi[_midi.length]=getMIDI(_chords[_c]);
    }
    playMIDI(_midi);
}

function showNextChords(){

  lastChord = document.getElementById("chordarea").value.split(/\r\n|\r|\n| |,/).pop();
  probs = probabilities[lastChord];

  var keyValues = [];

  for (var key in probs) {
    keyValues.push([ key, probs[key] ]);
  }

  sortedProbs=keyValues.sort(function compare(kv1, kv2) {
    return kv2[1] - kv1[1];
  });

  CR = String.fromCharCode(13);
  document.getElementById("nextChord").value="";
  for(var k in sortedProbs){
    document.getElementById("nextChord").value=document.getElementById("nextChord").value+sortedProbs[k][0]+" "+sortedProbs[k][1]+CR;
  }
}

window.onload = function()
{
	var param={};
	location.search.substring(1).split("&").forEach((p)=>{param[p.split("=")[0]]=p.split("=")[1]});

	if ("chord" in param){
		document.getElementById("chordarea").value=decodeURIComponent(param["chord"]);
	}

	if ("base" in param){
		var index = document.getElementsByName("base")[0].selectedIndex;
		document.getElementById("base")[index].text=param["base"];
		document.getElementById("base")[index].value=param["base"];
		base=parseInt(param["base"]);
	}

	if ("tempo" in param){
		document.getElementById("tempo").value=param["tempo"];
		tempo=60/parseInt(param["tempo"]);
	}
	
	if ("arpeggio" in param){
		document.getElementById("arpeggio").value=decodeURIComponent(param["arpeggio"]);
		arpeggio=decodeURIComponent(param["arpeggio"]);
	}
};

</script>

<h2>chord</h2>
<textarea id = "chordarea" onchange="showNextChords()">F:maj7 F:maj7 N F:maj7
G:7 G:7 G:7 G:7
E:min7 E:min7 N E:min7
A:min</textarea><button onclick='playChords(document.getElementById("chordarea").value)' value="play">play</button>
<h2>nextChord</h2>
<textarea id="nextChord" style="margin: 0px; height: 85px; width: 270px;"></textarea>
<h2>key</h2>
<select id="base" name="base" size="5" onchange="base=parseInt(this.value);console.log(base);">
<option value="36">36</option>
<option value="48">48</option>
<option value="60" selected="">60</option>
<option value="72">72</option>
<option value="84">84</option>
</select>
<h2>tempo</h2>
<input id="tempo" type="text" onchange="tempo=60/parseInt(this.value);console.log(tempo);" value="120">
<h2>arpeggio (0:skip, 1:root, example="1 2 3 2" )</h2>
<input id="arpeggio" type="text" style="width:270px;" onchange="arpeggio=this.value;console.log(arpeggio);" value="">
</body></html>
